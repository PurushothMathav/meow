<!DOCTYPE html>
<html lang="en">\>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Custom Player</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body { margin: 0; background: #000; color: #fff; font-family: sans-serif; }
    .player-container { position: relative; width: 100%; height: 100vh; background: #000; }
    video { width: 100%; height: 100%; background: #000; }

    .controls { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.5); padding: 10px; box-sizing: border-box; }
    .control-row { display: flex; align-items: center; justify-content: space-between; }
    .control-btn { background: none; border: none; color: #fff; font-size: 18px; margin: 0 5px; cursor: pointer; }
    .right-controls { display: flex; }

    .episodes-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.95); display: none; z-index: 300; overflow-y:auto; padding:20px; }
    .episodes-overlay.active { display:block; }
    .episodes-header { text-align:center; margin-bottom:20px; }
    .episodes-title { font-size:20px; font-weight:bold; }
    .episodes-meta { font-size:14px; color:#aaa; }
    .section-tabs { display:flex; gap:10px; justify-content:center; margin:10px 0; }
    .section-tabs button { background:#333; color:#fff; border:none; padding:5px 10px; cursor:pointer; border-radius:4px; }
    .episodes-grid { display:grid; grid-template-columns: repeat(6, 1fr); gap:5px; }
    .episode-number { background:#222; border:none; color:#fff; padding:8px; cursor:pointer; border-radius:4px; }

    .menu-overlay { position: absolute; bottom: 60px; right: 20px; background: #111; padding: 10px; border-radius: 6px; display: none; flex-direction: column; }
    .menu-overlay.active { display: flex; }
    .menu-item { background: none; border: none; color: #fff; padding: 5px; cursor: pointer; text-align: left; }
    .menu-item.active { font-weight:bold; }
  </style>
</head>
<body>
<div class="player-container">
  <video id="video" controls></video>
  <div class="controls">
    <div class="control-row">
      <div class="left-controls">
        <button class="control-btn" id="prevEpisode"><i class="fas fa-step-backward"></i></button>
        <button class="control-btn" id="nextEpisode"><i class="fas fa-step-forward"></i></button>
      </div>
      <div class="right-controls">
        <button class="control-btn" id="episodesBtn" title="Episodes">
          <i class="fas fa-list"></i>
        </button>
        <button class="control-btn" id="moreBtn" title="More">
          <i class="fas fa-ellipsis-v"></i>
        </button>
      </div>
    </div>
    <div class="extra-controls">
      <button class="control-btn" id="speedBtn" title="Playback Speed">
        <i class="fas fa-tachometer-alt"></i>
      </button>
      <button class="control-btn" id="qualityBtn" title="Quality">
        <i class="fas fa-cog"></i>
      </button>
    </div>
  </div>
</div>

<!-- Episodes Overlay -->
<div class="episodes-overlay" id="episodesOverlay">
  <div class="episodes-header">
    <div class="episodes-title" id="episodesTitle"></div>
    <div class="episodes-meta" id="episodesMeta"></div>
  </div>
  <div class="section-tabs" id="sectionTabs"></div>
  <div class="episodes-grid" id="episodesGrid"></div>
</div>

<!-- Speed Menu -->
<div class="menu-overlay" id="speedMenu">
  <button class="menu-item speed-option" data-speed="0.5">0.5x</button>
  <button class="menu-item speed-option active" data-speed="1">1x</button>
  <button class="menu-item speed-option" data-speed="1.25">1.25x</button>
  <button class="menu-item speed-option" data-speed="2">2x</button>
</div>

<!-- Quality Menu -->
<div class="menu-overlay" id="qualityMenu"></div>

<script>
class ReelPlayer {
  constructor(video) {
    this.video = video;
    this.currentShow = null;
    this.currentEpisodes = [];
    this.currentEpisodeIndex = 0;
    this.initializeEventListeners();
  }

  initializeEventListeners() {
    document.getElementById('episodesBtn').addEventListener('click', () => this.showEpisodesOverlay());
    document.getElementById('prevEpisode').addEventListener('click', () => this.loadEpisode(this.currentEpisodeIndex-1));
    document.getElementById('nextEpisode').addEventListener('click', () => this.loadEpisode(this.currentEpisodeIndex+1));

    // Speed menu
    document.getElementById('speedBtn').addEventListener('click', () => {
      document.getElementById('speedMenu').classList.toggle('active');
    });
    document.querySelectorAll('.speed-option').forEach(btn => {
      btn.addEventListener('click', e => {
        const speed = parseFloat(e.target.dataset.speed);
        this.video.playbackRate = speed;
        document.querySelectorAll('.speed-option').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        document.getElementById('speedMenu').classList.remove('active');
      });
    });

    // Quality toggle
    document.getElementById('qualityBtn').addEventListener('click', () => {
      document.getElementById('qualityMenu').classList.toggle('active');
    });
  }

  open(showData, episodeIndex=0) {
    this.currentShow = showData;
    this.currentEpisodes = showData.episodes || [];
    this.loadEpisode(episodeIndex);
  }

loadEpisode(index) {
  if (index < 0 || index >= this.currentEpisodes.length) return;
  this.currentEpisodeIndex = index;
  const episode = this.currentEpisodes[index];

  // pick a default quality (prefer 720p, fallback to others)
  const content = episode.content || {};
  const url =
    content.video_720p ||
    content.video_480p ||
    content.video_360p ||
    content.video_240p ||
    content.video_1080p ||
    "";

  if (!url) {
    console.error("No valid video URL for episode", episode);
    return;
  }

  // --- HLS.js handling ---
  if (Hls.isSupported()) {
    if (this.hls) {
      this.hls.destroy(); // cleanup old instance
    }
    this.hls = new Hls();
    this.hls.loadSource(url);
    this.hls.attachMedia(this.video);
  } else if (this.video.canPlayType("application/vnd.apple.mpegurl")) {
    // Safari native HLS support
    this.video.src = url;
  } else {
    console.error("HLS not supported in this browser");
    return;
  }

  // Populate Quality menu
  this.populateQualityMenu(content, url);

  // Don’t auto-play to avoid NotAllowedError
  // this.video.play();
}


populateQualityMenu(content, currentUrl) {
  const menu = document.getElementById("qualityMenu");
  menu.innerHTML = "";

  const qualities = Object.entries(content); // [["video_1080p", "url"], ...]

  qualities.forEach(([key, url]) => {
    const label = key.replace("video_", ""); // e.g. "720p"
    const btn = document.createElement("button");
    btn.className = "menu-item";
    if (url === currentUrl) btn.classList.add("active");
    btn.textContent = label;
    btn.addEventListener("click", () => {
      this.video.src = url;
      this.video.play();
      document.querySelectorAll("#qualityMenu .menu-item").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById("qualityMenu").classList.remove("active");
    });
    menu.appendChild(btn);
  });
}



  showEpisodesOverlay() {
    document.getElementById('episodesOverlay').classList.add('active');
    this.setupEpisodesOverlay();
  }

  setupEpisodesOverlay() {
    const show = this.currentShow?.show;
    const episodes = this.currentEpisodes;
    if (!show || !episodes) return;
    document.getElementById('episodesTitle').textContent = show.title;
    const lang = show.lang?.title || "Unknown";
    const rating = (show.labels || []).find(l => /\d+\+/.test(l)) || "NR";
    document.getElementById('episodesMeta').textContent = `${episodes.length} Episodes | ${lang} · ${rating}`;

    const sectionTabs = document.getElementById('sectionTabs');
    sectionTabs.innerHTML = '';
    const total = episodes.length;
    for (let start=1; start<=total; start+=30) {
      const end = Math.min(start+29, total);
      const btn = document.createElement('button');
      btn.textContent = `${start}-${end}`;
      btn.addEventListener('click', () => this.showEpisodeSection(start-1));
      sectionTabs.appendChild(btn);
    }
    this.showEpisodeSection(0);
  }

  showEpisodeSection(startIndex) {
    const grid = document.getElementById('episodesGrid');
    grid.innerHTML = '';
    const endIndex = Math.min(startIndex+30, this.currentEpisodes.length);
    for (let i=startIndex; i<endIndex; i++) {
      const epBtn = document.createElement('button');
      epBtn.className = 'episode-number';
      epBtn.textContent = i+1;
      epBtn.addEventListener('click', () => {
        this.loadEpisode(i);
        document.getElementById('episodesOverlay').classList.remove('active');
      });
      grid.appendChild(epBtn);
    }
  }
}

const reelPlayer = new ReelPlayer(document.getElementById('video'));

// Example load JSON (replace with your fetch)
fetch("json/7 Assasins-Tamil.json").then(res => res.json()).then(data => {
  reelPlayer.open(data, 0);
});
</script>
</body>
</html>
